name: Deploy to AWS

on:
  push:
    branches:
      - main      # 프로덕션 배포
      - develop   # 개발 서버 배포
  workflow_dispatch:
    inputs:
      environment:
        description: '배포 환경'
        required: true
        default: 'development'
        type: choice
        options:
          - development
          - production

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # 환경 결정
  setup:
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      domain: ${{ steps.set-env.outputs.domain }}
    steps:
      - name: Determine environment
        id: set-env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ENV="${{ github.event.inputs.environment }}"
          elif [ "${{ github.ref }}" == "refs/heads/main" ]; then
            ENV="production"
          else
            ENV="development"
          fi
          echo "environment=$ENV" >> $GITHUB_OUTPUT

          if [ "$ENV" == "production" ]; then
            echo "domain=${{ secrets.PROD_DOMAIN }}" >> $GITHUB_OUTPUT
          else
            echo "domain=${{ secrets.DEV_DOMAIN }}" >> $GITHUB_OUTPUT
          fi

  # CI 테스트
  test:
    needs: setup
    uses: ./.github/workflows/ci.yml
    secrets: inherit

  # Docker 이미지 빌드 및 푸시
  build:
    needs: [setup, test]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      image_tag: ${{ steps.meta.outputs.version }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=sha,prefix=

      - name: Build and push API
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./apps/api/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/api:${{ steps.meta.outputs.version }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/api:${{ needs.setup.outputs.environment }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push AI Service
        uses: docker/build-push-action@v5
        with:
          context: ./apps/ai-service
          file: ./apps/ai-service/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/ai-service:${{ steps.meta.outputs.version }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/ai-service:${{ needs.setup.outputs.environment }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push Admin
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./apps/admin/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/admin:${{ steps.meta.outputs.version }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/admin:${{ needs.setup.outputs.environment }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            NEXT_PUBLIC_API_URL=https://api.${{ needs.setup.outputs.domain }}

  # AWS EC2 배포
  deploy:
    needs: [setup, build]
    runs-on: ubuntu-latest
    environment: ${{ needs.setup.outputs.environment }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set EC2 variables
        id: ec2
        run: |
          if [ "${{ needs.setup.outputs.environment }}" == "production" ]; then
            echo "host=${{ secrets.PROD_EC2_HOST }}" >> $GITHUB_OUTPUT
            echo "user=${{ secrets.PROD_EC2_USER }}" >> $GITHUB_OUTPUT
          else
            echo "host=${{ secrets.DEV_EC2_HOST }}" >> $GITHUB_OUTPUT
            echo "user=${{ secrets.DEV_EC2_USER }}" >> $GITHUB_OUTPUT
          fi

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          if [ "${{ needs.setup.outputs.environment }}" == "production" ]; then
            echo "${{ secrets.PROD_EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          else
            echo "${{ secrets.DEV_EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          fi
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ steps.ec2.outputs.host }} >> ~/.ssh/known_hosts

      - name: Deploy to EC2
        env:
          HOST: ${{ steps.ec2.outputs.host }}
          USER: ${{ steps.ec2.outputs.user }}
          ENV: ${{ needs.setup.outputs.environment }}
          IMAGE_TAG: ${{ needs.setup.outputs.environment }}
          REGISTRY: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        run: |
          ssh $USER@$HOST << 'ENDSSH'
            cd /opt/travel-helper

            # GitHub Container Registry 로그인
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

            # 이미지 태그 설정
            export IMAGE_TAG=${{ env.IMAGE_TAG }}
            export REGISTRY=${{ env.REGISTRY }}

            # 새 이미지 풀
            docker compose -f docker-compose.ec2.yml pull

            # 롤링 업데이트
            docker compose -f docker-compose.ec2.yml up -d --no-deps api
            sleep 15

            # 헬스 체크
            for i in {1..10}; do
              if docker exec travel-helper-api wget -q --spider http://localhost:3000/api/health 2>/dev/null; then
                echo "API is healthy!"
                break
              fi
              echo "Waiting for API... ($i/10)"
              sleep 5
            done

            # 나머지 서비스 업데이트
            docker compose -f docker-compose.ec2.yml up -d --no-deps ai-service admin nginx

            # 오래된 이미지 정리
            docker image prune -af --filter "until=24h"

            echo "Deployment complete!"
          ENDSSH

      - name: Verify deployment
        run: |
          sleep 30
          DOMAIN="${{ needs.setup.outputs.domain }}"
          if [ -n "$DOMAIN" ]; then
            curl -sf "https://api.$DOMAIN/api/health" || echo "Health check pending"
          fi

      - name: Notify Discord
        if: always() && secrets.DISCORD_WEBHOOK != ''
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          status: ${{ job.status }}
          title: "${{ needs.setup.outputs.environment }} 배포"
          description: |
            환경: ${{ needs.setup.outputs.environment }}
            브랜치: ${{ github.ref_name }}
            커밋: ${{ github.sha }}
          color: ${{ job.status == 'success' && '0x00ff00' || '0xff0000' }}
